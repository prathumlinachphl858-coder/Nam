--==================================================
-- LOAD RAYFIELD (UI อยู่บรรทัดแรกสุด)
--==================================================
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

--==================================================
-- NamX Hub | Rayfield Core
-- Version : v1.7
-- Author  : Nam
--==================================================

if getgenv().NamXHubLoaded then
    warn("NamX Hub already loaded")
    return
end
getgenv().NamXHubLoaded = true

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--==================================================
-- CREATE WINDOW
--==================================================
local Window = Rayfield:CreateWindow({
    Name = "NamX Hub",
    LoadingTitle = "NamX Hub",
    LoadingSubtitle = "by Nam",
    ConfigurationSaving = { Enabled = true, FolderName = "NamXHub", FileName = "Config" },
    KeySystem = false
})

--==================================================
-- AIMBOT + HITBOX (ใช้ตัวใหม่ที่น้ำส่ง)
--==================================================
local AimbotTab = Window:CreateTab("Aimbot", 4483362458)
AimbotTab:CreateSection("Aimbot & Hitbox")

local aimPartName = "Head"
local FieldOfView = 100
local TeamCheck = true
local hitboxSize = Vector3.new(4,4,4)
local autoLockEnabled = true

-- วง FOV
local circle = Drawing.new("Circle")
circle.Visible = true
circle.Radius = FieldOfView
circle.Position = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
circle.Color = Color3.fromRGB(0, 255, 0)
circle.Thickness = 1
circle.Filled = false

function IsVisible(part)
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, Camera}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    local result = workspace:Raycast(Camera.CFrame.Position, (part.Position - Camera.CFrame.Position).Unit * 500, rayParams)
    return result and result.Instance:IsDescendantOf(part.Parent)
end

function GetClosestEnemy()
    local closest, shortest = nil, FieldOfView
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild(aimPartName) then
            if not TeamCheck or plr.Team ~= LocalPlayer.Team then
                local part = plr.Character[aimPartName]
                local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - circle.Position).Magnitude
                if onScreen and dist < shortest and IsVisible(part) and plr.Character:FindFirstChild("Humanoid") and plr.Character.Humanoid.Health > 0 then
                    closest = part
                    shortest = dist
                end
            end
        end
    end
    return closest
end

RunService.RenderStepped:Connect(function()
    local target = GetClosestEnemy()
    if target and autoLockEnabled then
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Position)
    end
end)

local function applyHitbox(char)
    local plr = Players:GetPlayerFromCharacter(char)
    if plr and (not TeamCheck or plr.Team ~= LocalPlayer.Team) then
        local function tryApply()
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                hrp.Size = hitboxSize
                hrp.Transparency = 0.7
                hrp.Material = Enum.Material.Neon
                hrp.Color = Color3.new(1, 0, 0)
            else
                task.delay(0.1, tryApply)
            end
        end
        tryApply()
    end
end

Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function(char)
        applyHitbox(char)
    end)
end)

for _, plr in ipairs(Players:GetPlayers()) do
    if plr.Character then applyHitbox(plr.Character) end
    plr.CharacterAdded:Connect(applyHitbox)
end

--==================================================
-- ESP TAB (คงของเดิม)
--==================================================
local VisualTab = Window:CreateTab("Visual", 4483362458)
VisualTab:CreateSection("ESP System")

local ESPConfig = {
    Box = false,
    Skeleton = false,
    Line = false,
    Name = false,
    Distance = false,
    HealthBar = false
}

local ESPObjects = {}
local HealthBarObjects = {}
local ESPConnection

local function getTeamColor(player)
    if player.Team == LocalPlayer.Team then
        return Color3.fromRGB(0,255,0)
    else
        return Color3.fromRGB(255,0,0)
    end
end

local function createESP(player)
    if player == LocalPlayer then return end
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end

    local objects = {}
    objects.Box = Drawing.new("Square")
    objects.Box.Thickness = 1
    objects.Box.Filled = false
    objects.Box.Visible = true

    objects.Skeleton = {}
    local parts = {"Head","UpperTorso","LowerTorso","LeftUpperArm","LeftLowerArm","LeftHand",
                   "RightUpperArm","RightLowerArm","RightHand",
                   "LeftUpperLeg","LeftLowerLeg","LeftFoot",
                   "RightUpperLeg","RightLowerLeg","RightFoot"}
    for _, partName in ipairs(parts) do
        local line = Drawing.new("Line")
        line.Thickness = 1
        line.Visible = true
        table.insert(objects.Skeleton, {partName, line})
    end

    objects.Line = Drawing.new("Line")
    objects.Line.Thickness = 1
    objects.Line.Visible = true

    objects.NameText = Drawing.new("Text")
    objects.NameText.Size = 13
    objects.NameText.Center = true
    objects.NameText.Outline = true
    objects.NameText.Font = 2
    objects.NameText.Visible = true

    objects.DistanceText = Drawing.new("Text")
    objects.DistanceText.Size = 13
    objects.DistanceText.Center = true
    objects.DistanceText.Outline = true
    objects.DistanceText.Font = 2
    objects.DistanceText.Visible = true

    ESPObjects[player] = objects
end

local function removeESP(player)
    if ESPObjects[player] then
        local obj = ESPObjects[player]
        for k,v in pairs(obj) do
            if type(v)=="table" then
                for _, line in ipairs(v) do line[2]:Remove() end
            else
                v:Remove()
            end
        end
        ESPObjects[player] = nil
    end
end

local function createHealthBar(player)
    if player == LocalPlayer then return end
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local healthBar = Drawing.new("Square")
    healthBar.Thickness = 1
    healthBar.Filled = true
    healthBar.Visible = true
    HealthBarObjects[player] = healthBar
end

local function removeHealthBar(player)
    if HealthBarObjects[player] then
        HealthBarObjects[player]:Remove()
        HealthBarObjects[player] = nil
    end
end

local function updateESP()
    for player,obj in pairs(ESPObjects) do
        local char = player.Character
        local humanoid = char and char:FindFirstChildOfClass("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if hrp and humanoid then
            local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            local distance = (Camera.CFrame.Position - hrp.Position).Magnitude
            local color = getTeamColor(player)

            -- Box
            if obj.Box then
                local size = math.clamp(3000/distance,20,80)
                obj.Box.Size = Vector2.new(size,size)
                obj.Box.Position = Vector2.new(pos.X-size/2,pos.Y-size/2)
                obj.Box.Color = color
                obj.Box.Visible = ESPConfig.Box and onScreen
            end

            -- Skeleton
            if obj.Skeleton and ESPConfig.Skeleton then
                local function getPartPos(name)
                    local p = char:FindFirstChild(name)
                    if p then
                        local screenPos, onScreen = Camera:WorldToViewportPoint(p.Position)
                        return Vector2.new(screenPos.X,screenPos.Y), onScreen
                    end
                    return Vector2.new(0,0), false
                end

                for _, lineData in ipairs(obj.Skeleton) do
                    local fromPos, fromScreen = getPartPos(lineData[1])
                    local toPos = fromPos
                    lineData[2].From = fromPos
                    lineData[2].To = toPos
                    lineData[2].Color = color
                    lineData[2].Visible = ESPConfig.Skeleton and fromScreen
                end
            end

            -- Line
            if obj.Line then
                local screenCenter = Vector2.new(Camera.ViewportSize.X/2,Camera.ViewportSize.Y/2)
                obj.Line.From = screenCenter
                obj.Line.To = Vector2.new(pos.X,pos.Y)
                obj.Line.Color = color
                obj.Line.Visible = ESPConfig.Line and onScreen
            end

            -- Name
            if obj.NameText then
                obj.NameText.Text = player.Name
                obj.NameText.Position = Vector2.new(pos.X,pos.Y-20)
                obj.NameText.Color = color
                obj.NameText.Visible = ESPConfig.Name and onScreen
            end

            -- Distance
            if obj.DistanceText then
                obj.DistanceText.Text = string.format("[%.0f]",distance)
                obj.DistanceText.Position = Vector2.new(pos.X,pos.Y-10)
                obj.DistanceText.Color = color
                obj.DistanceText.Visible = ESPConfig.Distance and onScreen
            end
        else
            for k,v in pairs(obj) do
                if type(v)=="table" then
                    for _,l in ipairs(v) do l[2].Visible=false end
                else
                    v.Visible=false
                end
            end
        end
    end

    for player,bar in pairs(HealthBarObjects) do
        local char = player.Character
        local humanoid = char and char:FindFirstChildOfClass("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if hrp and humanoid then
            local pos,_ = Camera:WorldToViewportPoint(hrp.Position)
            local distance = (Camera.CFrame.Position - hrp.Position).Magnitude
            local barHeight = math.clamp(3000/distance,20,80)
            local barWidth = 4
            local hpPercent = humanoid.Health/humanoid.MaxHealth
            bar.Size = Vector2.new(barWidth, barHeight*hpPercent)
            bar.Position = Vector2.new(pos.X+25,pos.Y+barHeight*(1-hpPercent)/2 - barHeight/2)
            bar.Color = Color3.fromRGB(255*(1-hpPercent),255*hpPercent,0)
            bar.Visible = ESPConfig.HealthBar and onScreen
        else
            bar.Visible=false
        end
    end
end

local function enableESPLoop()
    for _,plr in ipairs(Players:GetPlayers()) do createESP(plr); createHealthBar(plr) end
    ESPConnection = RunService.RenderStepped:Connect(updateESP)
    Players.PlayerAdded:Connect(function(p) createESP(p); createHealthBar(p) end)
    Players.PlayerRemoving:Connect(function(p) removeESP(p); removeHealthBar(p) end)
end

enableESPLoop()

--================ UI TOGGLE =====================
VisualTab:CreateToggle({Name="ESP Box",CurrentValue=false,Callback=function(v) ESPConfig.Box=v end})
VisualTab:CreateToggle({Name="ESP Skeleton",CurrentValue=false,Callback=function(v) ESPConfig.Skeleton=v end})
VisualTab:CreateToggle({Name="ESP Line",CurrentValue=false,Callback=function(v) ESPConfig.Line=v end})
VisualTab:CreateToggle({Name="ESP Name",CurrentValue=false,Callback=function(v) ESPConfig.Name=v end})
VisualTab:CreateToggle({Name="ESP Distance",CurrentValue=false,Callback=function(v) ESPConfig.Distance=v end})
VisualTab:CreateToggle({Name="ESP Health Bar",CurrentValue=false,Callback=function(v) ESPConfig.HealthBar=v end})
