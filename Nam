-- ================= LOAD RAYFIELD =================
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "NamX Control Hub",
    LoadingTitle = "NamX Control Hub",
    LoadingSubtitle = "by Nam",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false
})

local ESPTab   = Window:CreateTab("ESP", 4483362458)
local PerfTab  = Window:CreateTab("Performance", 4483362458)
local AimTab   = Window:CreateTab("Aimbot", 4483362458)
local MiscTab  = Window:CreateTab("Misc", 4483362458)
local BuildTab = Window:CreateTab("Build", 4483362458)

-- ================= SERVICES =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Lighting = game:GetService("Lighting")

-- ================= ESP SETTINGS =================
local ESP_ENABLED   = false
local BOX_ENABLED   = true
local LINE_ENABLED  = true
local HEALTH_ENABLED = true
local DIST_ENABLED  = true

local ESP_TABLE = {}

-- ================= ESP UTILS =================
local function newLine(thickness)
    local l = Drawing.new("Line")
    l.Thickness = thickness or 1
    l.Visible = false
    return l
end

-- ================= CREATE ESP =================
local function createESP(player)
    if player == LocalPlayer then return end

    local box = Drawing.new("Square")
    box.Filled = false
    box.Thickness = 1
    box.Visible = false

    local tracer = newLine(1)
    local health = newLine(3)

    local name = Drawing.new("Text")
    name.Size = 13
    name.Center = true
    name.Outline = true
    name.Visible = false

    local dist = Drawing.new("Text")
    dist.Size = 12
    dist.Center = true
    dist.Outline = true
    dist.Visible = false

    ESP_TABLE[player] = {
        box = box,
        tracer = tracer,
        health = health,
        name = name,
        dist = dist
    }
end

local function removeESP(player)
    if ESP_TABLE[player] then
        for _,v in pairs(ESP_TABLE[player]) do
            v:Remove()
        end
        ESP_TABLE[player] = nil
    end
end

for _,p in ipairs(Players:GetPlayers()) do
    createESP(p)
end
Players.PlayerAdded:Connect(createESP)
Players.PlayerRemoving:Connect(removeESP)

-- ================= ESP RENDER =================
RunService.RenderStepped:Connect(function()
    local myChar = LocalPlayer.Character
    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")

    for player,esp in pairs(ESP_TABLE) do
        local char = player.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")

        -- ซ่อนทุกอย่างก่อน (แก้ค้าง)
        esp.box.Visible = false
        esp.tracer.Visible = false
        esp.health.Visible = false
        esp.name.Visible = false
        esp.dist.Visible = false

        if not ESP_ENABLED then continue end
        if not hum or not hrp or hum.Health <= 0 then continue end

        local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
        if not onScreen then continue end

        -- สีตามทีม
        local color = Color3.fromRGB(255,0,0)
        if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
            color = Color3.fromRGB(0,255,0)
        end

        local size = Vector2.new(2000 / pos.Z, 3000 / pos.Z)
        local x = pos.X - size.X / 2
        local y = pos.Y - size.Y / 2

        -- BOX
        if BOX_ENABLED then
            esp.box.Size = size
            esp.box.Position = Vector2.new(x, y)
            esp.box.Color = color
            esp.box.Visible = true
        end

        -- NAME
        esp.name.Text = player.Name
        esp.name.Color = color
        esp.name.Position = Vector2.new(pos.X, y - 14)
        esp.name.Visible = true

        -- DISTANCE
        if DIST_ENABLED and myHRP then
            local d = (myHRP.Position - hrp.Position).Magnitude
            esp.dist.Text = math.floor(d) .. " studs"
            esp.dist.Color = color
            esp.dist.Position = Vector2.new(pos.X, y - 2)
            esp.dist.Visible = true
        end

        -- LINE
        if LINE_ENABLED then
            esp.tracer.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
            esp.tracer.To = Vector2.new(pos.X, pos.Y)
            esp.tracer.Color = color
            esp.tracer.Visible = true
        end

        -- HEALTH BAR
        if HEALTH_ENABLED then
            local hp = hum.Health / hum.MaxHealth
            local barHeight = size.Y * hp
            esp.health.From = Vector2.new(x - 5, y + size.Y)
            esp.health.To = Vector2.new(x - 5, y + size.Y - barHeight)
            esp.health.Color = Color3.fromRGB(0,255,0)
            esp.health.Visible = true
        end
    end
end)

-- ================= ESP UI =================
ESPTab:CreateToggle({
    Name = "Enable ESP",
    CurrentValue = false,
    Callback = function(v) ESP_ENABLED = v end
})

ESPTab:CreateToggle({
    Name = "Box (2D)",
    CurrentValue = true,
    Callback = function(v) BOX_ENABLED = v end
})

ESPTab:CreateToggle({
    Name = "Line",
    CurrentValue = true,
    Callback = function(v) LINE_ENABLED = v end
})

ESPTab:CreateToggle({
    Name = "Health Bar",
    CurrentValue = true,
    Callback = function(v) HEALTH_ENABLED = v end
})

ESPTab:CreateToggle({
    Name = "Distance",
    CurrentValue = true,
    Callback = function(v) DIST_ENABLED = v end
})
