--==================================================
-- NamX Hub | Rayfield Core
-- Version : v1.5
-- Author  : Nam
--==================================================

if getgenv().NamXHubLoaded then
    warn("NamX Hub already loaded")
    return
end
getgenv().NamXHubLoaded = true

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--==================================================
-- LOAD RAYFIELD
--==================================================
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

--==================================================
-- CREATE WINDOW
--==================================================
local Window = Rayfield:CreateWindow({
    Name = "NamX Hub",
    LoadingTitle = "NamX Hub",
    LoadingSubtitle = "by Nam",
    ConfigurationSaving = { Enabled = true, FolderName = "NamXHub", FileName = "Config" },
    KeySystem = false
})

--==================================================
-- AIMBOT + HITBOX TAB (UI สร้างก่อน)
--==================================================
local AimbotTab = Window:CreateTab("Aimbot", 4483362458)
AimbotTab:CreateSection("Aimbot & Hitbox")

local AimbotConfig = {
    Enabled = false,
    TargetPart = "Head",
    FOV = 120,
    Smoothness = 0.15,
    WallCheck = true,
    HitboxEnabled = false,
    HitboxSizeHead = 6,
    HitboxSizeBody = 10,
    HitboxTransparency = 0.7
}

local HitboxCache = {}

-- FOV Circle
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 1
FOVCircle.NumSides = 64
FOVCircle.Filled = false
FOVCircle.Visible = false
FOVCircle.Color = Color3.fromRGB(255,255,255)

--================ FUNCTIONS =====================
local function isVisible(targetPart)
    local origin = Camera.CFrame.Position
    local direction = (targetPart.Position - origin)
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {LocalPlayer.Character, targetPart.Parent}
    local result = workspace:Raycast(origin, direction, params)
    if result then
        return result.Instance:IsDescendantOf(targetPart.Parent)
    end
    return true
end

local function getClosestTargetInFOV()
    local closestPlayer = nil
    local shortestDistance = math.huge
    local mousePos = UserInputService:GetMouseLocation()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Team ~= LocalPlayer.Team then
            local char = player.Character
            local part = char and char:FindFirstChild(AimbotConfig.TargetPart)
            local humanoid = char and char:FindFirstChildOfClass("Humanoid")
            if part and humanoid and humanoid.Health > 0 then
                if AimbotConfig.WallCheck and not isVisible(part) then continue end
                local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                    if dist < AimbotConfig.FOV and dist < shortestDistance then
                        shortestDistance = dist
                        closestPlayer = part
                    end
                end
            end
        end
    end
    return closestPlayer
end

local function applyHitbox(player)
    if not AimbotConfig.HitboxEnabled then return end
    if player == LocalPlayer or player.Team == LocalPlayer.Team then return end
    local char = player.Character
    if not char then return end
    local targetPartName = AimbotConfig.TargetPart
    local part = char:FindFirstChild(targetPartName)
    if not part or not part:IsA("BasePart") then return end
    if not HitboxCache[part] then
        HitboxCache[part] = {Size=part.Size,Transparency=part.Transparency,CanCollide=part.CanCollide}
    end
    local size = (targetPartName=="Head") and AimbotConfig.HitboxSizeHead or AimbotConfig.HitboxSizeBody
    part.Size = Vector3.new(size,size,size)
    part.Transparency = AimbotConfig.HitboxTransparency
    part.CanCollide = false
end

local function restoreHitbox()
    for part, data in pairs(HitboxCache) do
        if part and part.Parent then
            part.Size = data.Size
            part.Transparency = data.Transparency
            part.CanCollide = data.CanCollide
        end
    end
    table.clear(HitboxCache)
end

--================ AIMBOT LOOP =====================
RunService.RenderStepped:Connect(function()
    local mousePos = UserInputService:GetMouseLocation()
    FOVCircle.Position = mousePos
    FOVCircle.Radius = AimbotConfig.FOV
    FOVCircle.Visible = AimbotConfig.Enabled

    if not AimbotConfig.Enabled then return end
    local targetPart = getClosestTargetInFOV()
    if targetPart then
        local camPos = Camera.CFrame.Position
        local newCFrame = CFrame.new(camPos, targetPart.Position)
        Camera.CFrame = Camera.CFrame:Lerp(newCFrame, AimbotConfig.Smoothness)
    end

    if AimbotConfig.HitboxEnabled then
        for _, plr in ipairs(Players:GetPlayers()) do
            applyHitbox(plr)
        end
    else
        restoreHitbox()
    end
end)

--================ UI =====================
AimbotTab:CreateToggle({Name="Enable Aimbot",CurrentValue=false,Callback=function(v) AimbotConfig.Enabled=v end})
AimbotTab:CreateDropdown({Name="Target Part",Options={"Head","HumanoidRootPart"},CurrentOption="Head",Callback=function(v) AimbotConfig.TargetPart=v end})
AimbotTab:CreateSlider({Name="FOV Size",Range={50,400},Increment=5,CurrentValue=120,Callback=function(v) AimbotConfig.FOV=v end})
AimbotTab:CreateSlider({Name="Smoothness",Range={0.05,1},Increment=0.05,CurrentValue=0.15,Callback=function(v) AimbotConfig.Smoothness=v end})
AimbotTab:CreateToggle({Name="Wall Check",CurrentValue=true,Callback=function(v) AimbotConfig.WallCheck=v end})
AimbotTab:CreateToggle({Name="Enable Hitbox",CurrentValue=false,Callback=function(v) AimbotConfig.HitboxEnabled=v if not v then restoreHitbox() end end})
AimbotTab:CreateSlider({Name="Hitbox Size (Head)",Range={4,20},Increment=1,CurrentValue=AimbotConfig.HitboxSizeHead,Callback=function(v) AimbotConfig.HitboxSizeHead=v end})
AimbotTab:CreateSlider({Name="Hitbox Size (Body)",Range={6,30},Increment=1,CurrentValue=AimbotConfig.HitboxSizeBody,Callback=function(v) AimbotConfig.HitboxSizeBody=v end})

--==================================================
-- VISUAL / ESP TAB
--==================================================
local VisualTab = Window:CreateTab("Visual", 4483362458)
VisualTab:CreateSection("ESP System")

-- (โค้ด ESP + HealthBar เหมือนเดิมทั้งหมด)
-- Toggle ของ Box, Skeleton, Line, Name, Distance, HealthBar
-- Loop updateESP, createESP, removeESP เหมือนใน v1.4

-- เริ่ม Loop
for _, plr in ipairs(Players:GetPlayers()) do createESP(plr); createHealthBar(plr) end
enableESPLoop()
