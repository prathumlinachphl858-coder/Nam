-- ================= LOAD RAYFIELD =================
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "NamX HUB",
    LoadingTitle = "NamX HUB",
    LoadingSubtitle = "by น้ำ",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "NamXConfig",
        FileName = "Settings"
    },
    KeySystem = false
})

local MainTab = Window:CreateTab("ESP")
local AimTab = Window:CreateTab("AimBot")

-- ================= SERVICES =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ================= ESP DATA =================
local ESP = {
    Enabled = false,
    Box = true,
    Skeleton = true,
    Health = true,
    Distance = true,
    MaxDistance = 800,
    Boxes = {},
    Skeletons = {},
    HealthBars = {},
    Distances = {}
}

-- ================= AIMBOT DATA =================
local AimBot = {
    Enabled = false,
    FOV = 100,
    Smoothness = 0.3,
    EnemyOnly = true
}

-- ================= UTILS =================
local function GetTeamColor(player)
    return player.Team and player.TeamColor.Color or Color3.fromRGB(255,255,255)
end

local function GetDistance(char)
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return nil end
    return (char.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
end

local function GetClosestEnemy()
    local closest, minDist = nil, AimBot.FOV
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if AimBot.EnemyOnly and player.Team == LocalPlayer.Team then continue end
            local screenPos, onScreen = Camera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if dist < minDist then
                    closest = player
                    minDist = dist
                end
            end
        end
    end
    return closest
end

-- ================= CREATE / REMOVE ESP =================
local function CreateESP(player)
    if player == LocalPlayer then return end
    if ESP.Boxes[player] then return end

    local box = Drawing.new("Square")
    box.Thickness = 2
    box.Filled = false
    box.Visible = false
    ESP.Boxes[player] = box

    ESP.Skeletons[player] = {}
    for i = 1, 9 do
        local l = Drawing.new("Line")
        l.Thickness = 2
        l.Visible = false
        table.insert(ESP.Skeletons[player], l)
    end

    local hp = Drawing.new("Square")
    hp.Filled = true
    hp.Visible = false
    ESP.HealthBars[player] = hp

    local dist = Drawing.new("Text")
    dist.Size = 14
    dist.Center = true
    dist.Outline = true
    dist.Visible = false
    ESP.Distances[player] = dist
end

local function RemoveESP(player)
    if ESP.Boxes[player] then ESP.Boxes[player]:Remove() end
    if ESP.Skeletons[player] then
        for _,l in pairs(ESP.Skeletons[player]) do l:Remove() end
    end
    if ESP.HealthBars[player] then ESP.HealthBars[player]:Remove() end
    if ESP.Distances[player] then ESP.Distances[player]:Remove() end

    ESP.Boxes[player] = nil
    ESP.Skeletons[player] = nil
    ESP.HealthBars[player] = nil
    ESP.Distances[player] = nil
end

-- ================= BOX 2D (HUB STANDARD) =================
local function UpdateBox2D(player)
    local char = player.Character
    if not char then return false end

    local head = char:FindFirstChild("Head")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not head or not root then return false end

    local headPos, onH = Camera:WorldToViewportPoint(head.Position + Vector3.new(0,0.3,0))
    local rootPos, onR = Camera:WorldToViewportPoint(root.Position - Vector3.new(0,0.2,0))
    if not (onH and onR) then return false end

    local height = math.abs(headPos.Y - rootPos.Y)
    if height < 8 then return false end

    local width = height * 0.55
    local box = ESP.Boxes[player]

    box.Size = Vector2.new(width, height)
    box.Position = Vector2.new(headPos.X - width/2, headPos.Y)
    box.Color = GetTeamColor(player)
    box.Visible = ESP.Box
    return true
end

-- ================= UPDATE LOOP =================
RunService.RenderStepped:Connect(function()
    -- ESP
    if ESP.Enabled then
        for player,_ in pairs(ESP.Boxes) do
            local char = player.Character
            local humanoid = char and char:FindFirstChild("Humanoid")
            local root = char and char:FindFirstChild("HumanoidRootPart")
            local head = char and char:FindFirstChild("Head")

            if humanoid and root and head then
                local distValue = GetDistance(char)
                if distValue and distValue <= ESP.MaxDistance then
                    local color = GetTeamColor(player)
                    local boxVisible = false
                    if ESP.Box then
                        boxVisible = UpdateBox2D(player)
                    else
                        ESP.Boxes[player].Visible = false
                    end

                    -- Health Bar
                    local bar = ESP.HealthBars[player]
                    if ESP.Health and boxVisible then
                        local hpPercent = math.clamp(humanoid.Health / humanoid.MaxHealth,0,1)
                        local box = ESP.Boxes[player]
                        local h = box.Size.Y * hpPercent

                        bar.Size = Vector2.new(4,h)
                        bar.Position = Vector2.new(box.Position.X-6, box.Position.Y+(box.Size.Y-h))
                        bar.Color = Color3.fromRGB(255*(1-hpPercent), 255*hpPercent, 0)
                        bar.Visible = true
                    else
                        bar.Visible = false
                    end

                    -- Distance
                    local text = ESP.Distances[player]
                    if ESP.Distance and boxVisible then
                        text.Text = math.floor(distValue).."m"
                        local box = ESP.Boxes[player]
                        text.Position = Vector2.new(box.Position.X+box.Size.X/2, box.Position.Y+box.Size.Y+2)
                        text.Color = color
                        text.Visible = true
                    else
                        text.Visible = false
                    end
                else
                    ESP.Boxes[player].Visible = false
                    ESP.HealthBars[player].Visible = false
                    ESP.Distances[player].Visible = false
                end
            end
        end
    end

    -- AimBot
    if AimBot.Enabled then
        local target = GetClosestEnemy()
        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = target.Character.HumanoidRootPart
            local camCFrame = Camera.CFrame
            local direction = (hrp.Position - camCFrame.Position).Unit
            Camera.CFrame = camCFrame:Lerp(CFrame.new(camCFrame.Position, camCFrame.Position + direction), AimBot.Smoothness)
        end
    end
end)

-- ================= UI =================
MainTab:CreateButton({
    Name = "Toggle ESP",
    Callback = function()
        ESP.Enabled = not ESP.Enabled
        if ESP.Enabled then
            for _,p in pairs(Players:GetPlayers()) do CreateESP(p) end
        else
            for p,_ in pairs(ESP.Boxes) do RemoveESP(p) end
        end
    end
})

MainTab:CreateToggle({Name="Box",CurrentValue=true,Callback=function(v)ESP.Box=v end})
MainTab:CreateToggle({Name="Skeleton",CurrentValue=true,Callback=function(v)ESP.Skeleton=v end})
MainTab:CreateToggle({Name="Health Bar",CurrentValue=true,Callback=function(v)ESP.Health=v end})
MainTab:CreateToggle({Name="Distance",CurrentValue=true,Callback=function(v)ESP.Distance=v end})

-- AimBot UI
AimTab:CreateToggle({Name="Enable AimBot",CurrentValue=false,Callback=function(v) AimBot.Enabled=v end})
AimTab:CreateSlider({Name="FOV",Min=50,Max=1000,CurrentValue=100,Callback=function(v) AimBot.FOV=v end})
AimTab:CreateSlider({Name="Smoothness",Min=0.01,Max=1,CurrentValue=0.3,Callback=function(v) AimBot.Smoothness=v end})
AimTab:CreateToggle({Name="Enemy Only",CurrentValue=true,Callback=function(v) AimBot.EnemyOnly=v end})
